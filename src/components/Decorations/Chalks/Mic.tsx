import { useRef, useCallback } from 'react'
import gsap from 'gsap'
import { MorphSVGPlugin } from 'gsap/MorphSVGPlugin'
import cn from 'classnames'

gsap.registerPlugin(MorphSVGPlugin)

/** Unified viewBox to prevent cropping during morph (from 183×176 to 188×163) */
const VIEWBOX = '0 0 188 176'

/** Scale initial (183×176) to match final (188×163) size */
const INITIAL_SCALE = { x: 188 / 183, y: 163 / 176 }

/** Original path (183×176 space) - 1 path */
const ORIGINAL_PATHS = [
  'M99.9667 87.3245C99.797 87.9513 102.175 98.064 102.341 100.063C103.066 108.776 102.42 121.916 101.707 130.778C101.23 136.735 100.157 150.216 98.6162 155.427C97.795 158.206 93.8446 159.928 91.8404 157.44C89.7052 154.786 87.3405 136.75 86.8035 132.312C85.0096 117.482 84.9113 102.207 84.256 87.4579C71.8947 79.4615 66.6371 65.2747 75.8356 52.6286C85.993 38.6661 108.544 46.3436 114.732 59.6928C117.251 65.1236 115.772 74.2583 111.773 78.6932C109.114 81.6402 100.837 84.0874 99.9628 87.3038L99.9667 87.3245ZM78.6102 55.3147C78.0827 56.3278 74.9543 60.2138 76.3553 61.1006L88.09 62.8048L88.5325 58.7603L78.6102 55.3147ZM89.1356 55.3278C89.6067 55.2477 91.0388 49.6598 90.2048 49.1228C86.326 48.4049 83.1986 50.4699 80.6643 53.2771L89.1356 55.3278ZM87.7893 69.4722C87.6865 68.8523 81.873 67.9715 80.7568 67.6561C79.4633 67.2942 75.1819 64.6376 74.3177 65.9669C72.4684 68.7942 80.5272 83.7387 84.2657 85.0134C87.9001 83.6117 95.801 85.2011 98.8197 83.8912C101.838 82.5813 108.528 77.1445 110.233 74.2297C113.377 68.8778 110.454 71.1834 107.798 71.3967C105.671 71.5633 103.466 71.1183 101.338 71.4831L100.1 75.3872L107.968 75.2297C106.052 77.0243 101.069 76.6764 99.3022 77.7657C98.3029 78.384 97.5146 81.7454 95.7965 82.4426C94.6063 81.5198 95.434 80.0953 96.011 79.0907C96.3576 77.4201 89.711 77.5757 89.1265 77.9154C87.912 78.6152 87.4585 80.7932 86.0988 81.5873L85.8985 77.3825L77.2681 75.0791C77.2511 73.4479 85.3797 75.5175 86.3672 74.8206L87.7852 69.468L87.7893 69.4722ZM102.433 53.3815C102.378 52.3943 94.5371 48.7942 93.4943 50.2754L93.7548 55.8307L100.265 56.8348L102.433 53.3815ZM93.0454 59.6963L92.8879 63.1559C96.4883 63.0011 100.699 65.7854 100.2 60.0471L93.0454 59.6963ZM108.5 57.8643C106.836 56.3196 105.457 54.0496 103.087 53.5872L103.148 57.1264L108.5 57.8643ZM98.2635 71.9544C98.0858 70.851 92.4664 69.9589 91.2428 70.2086L90.0109 74.9592L96.8757 75.4407L98.2635 71.9544ZM109.307 58.7728L103.01 60.1484L102.672 64.0158L111.891 64.9348C112.853 64.3039 112.218 64.2758 112.081 63.7383C111.804 62.6508 110.341 59.0053 109.311 58.7687L109.307 58.7728ZM96.9847 87.0159C94.348 88.0304 88.2288 85.5005 86.8766 88.6401C84.5208 94.1158 94.4879 92.016 97.1837 91.394C98.5989 90.9141 97.8991 87.2849 96.9847 87.0159ZM87.2201 94.1381L89.5756 131.975C90.3563 133.581 95.671 132.126 97.4344 133.696C98.584 133.405 98.8189 128.393 98.9107 127.13C99.3803 120.517 99.9915 110.362 99.7996 103.895C99.7531 102.358 99.3065 95.1586 97.9598 94.7511C94.5441 95.0431 90.2855 96.0204 87.2243 94.1339L87.2201 94.1381ZM90.5483 134.982L89.9624 136.069C91.1927 141.659 91.0331 148.769 92.6073 154.182C93.2836 156.515 94.68 156.34 95.3435 154.233C96.8904 149.311 96.4133 142.338 98.0317 137.222C97.5528 134.99 92.1825 136.713 90.5483 134.982Z',
] as const

/** Final paths (188×163 space) - 3 paths */
const FINAL_PATHS = [
  'M103.398 74.8917C103.62 75.7292 113.122 85.8283 114.65 88.0273C121.305 97.6114 129.332 113.226 134.425 123.942C137.85 131.142 145.61 147.435 147.308 154.485C148.214 158.244 144.795 162.869 140.816 161.332C136.575 159.69 121.797 140.426 118.213 135.656C106.236 119.717 95.9236 102.133 85.3177 85.527C65.6829 84.5337 50.1302 71.6483 52.3243 50.8993C54.7485 27.9893 85.9541 21.8166 102.024 33.1131C108.563 37.7077 112.953 49.2494 111.289 57.0419C110.181 62.2212 102.242 70.571 103.379 74.8705L103.398 74.8917ZM57.3266 52.152C57.393 53.6745 56.3697 60.2519 58.5821 60.3419L73.2909 54.4826L71.1021 49.514L57.3266 52.152ZM69.5077 45.1454C69.9991 44.7385 67.9242 37.3263 66.6012 37.2622C61.6361 39.0203 59.3981 43.4928 58.3416 48.4273L69.5077 45.1454ZM77.3949 62.3874C76.8621 61.7396 69.5509 64.6002 68.0493 64.9804C66.3119 65.4252 59.5866 65.2117 59.4748 67.3242C59.2238 71.8249 78.5221 83.7171 83.6967 82.6959C86.9639 78.6516 97.1624 75.2172 99.7788 71.6898C102.395 68.1623 106.501 57.4173 106.528 52.9116C106.589 44.6305 104.749 49.2444 101.82 51.2626C99.4713 52.874 96.6241 53.8309 94.4062 55.6723L95.5812 61.0094L104.576 55.5782C103.558 58.9301 97.5624 61.8528 96.2469 64.2899C95.5041 65.6711 96.8368 70.081 95.3154 72.0328C93.3227 71.7605 93.3289 69.5623 93.3254 68.0166C92.6108 65.855 85.028 70.4689 84.5788 71.2513C83.6415 72.8703 84.5713 75.6894 83.529 77.5141L80.4899 72.7891L68.971 75.8851C67.8623 74.0116 78.6447 70.9802 79.3214 69.5161L77.3874 62.3853L77.3949 62.3874ZM83.5859 34.0256C82.8635 32.9214 71.392 33.9923 71.175 36.3995L75.1856 42.6449L83.3849 39.462L83.5859 34.0256ZM76.9461 47.5848L79.0739 51.6874C83.1344 49.1066 89.8627 49.515 85.4547 43.2171L76.9461 47.5848ZM93.5962 35.1576C90.6399 34.4831 87.53 32.7797 84.4805 33.8265L86.9138 37.8755L93.5962 35.1576ZM91.1654 58.268C90.2232 57.1114 83.1289 59.8295 81.8805 60.9343L83.6278 67.2455L91.8883 63.2221L91.1654 58.268ZM95.1355 35.6694L88.7722 41.4593L90.9636 46.1537L102.238 41.0656C102.93 39.6946 102.176 40.0862 101.659 39.556C100.613 38.4842 96.4869 35.2479 95.1376 35.6618L95.1355 35.6694ZM99.743 76.5245C97.3711 79.4559 88.6052 80.6148 89.1377 85.1447C90.0694 93.0435 100.194 83.9678 102.896 81.4507C104.213 79.952 100.98 76.2253 99.743 76.5245ZM93.2059 91.2684L121.194 133.418C123.169 134.753 128.344 129.526 131.431 130.164C132.566 129.06 129.492 123.112 128.755 121.592C124.882 113.637 118.809 101.495 114.268 94.1501C113.189 92.4059 107.865 84.3844 106.035 84.812C102.28 87.4282 98.0078 91.3984 93.208 91.2609L93.2059 91.2684ZM124.326 136.244L124.375 137.891C129.529 143.528 134.092 151.85 139.527 157.055C141.867 159.299 143.365 158.166 142.726 155.289C141.228 148.569 136.021 140.83 134.476 133.839C132.432 131.579 127.372 137.153 124.326 136.244Z',
  'M23.5249 10.1803C30.0138 6.3648 37.2937 3.06622 38.2684 13.8806C35.7257 17.507 34.3262 11.4386 32.4814 11.331C28.5737 11.6774 26.5451 15.982 22.4882 14.1595C25.511 21.9969 30.3884 30.7668 31.8395 39.0397C33.5228 48.6295 18.0346 62.9396 13.7616 56.3452C9.48872 49.7508 19.2132 40.0414 25.9678 40.8222L27.0644 39.7191C22.7399 30.7223 18.5062 20.3073 16.4577 10.5014C14.5697 1.46933 20.5577 5.15439 23.5229 10.1736L23.5249 10.1803Z',
  'M177.38 60.7103C175.839 63.8434 173.41 67.7488 170.138 69.4353C167.436 70.8268 162.827 72.3017 161.717 68.3273C160.398 63.6007 170.81 51.8104 174.029 48.2713L170.619 27.9211L135.921 37.672L138.003 45.34C146.378 42.6433 154.215 38.1354 162.766 35.8922C165.347 35.2181 170.318 33.6276 170.739 37.5232C168.322 40.1421 165.408 40.0684 162.699 41.0523C154.925 43.8788 147.159 46.6361 139.032 48.2129C142.88 57.5592 145.456 70.6637 137.874 78.9149C135.17 81.8606 128.288 86.4912 126.061 80.9574C123.834 75.4236 133.586 65.1573 137.913 62.2422C136.453 57.0437 134.665 51.9285 133.319 46.6962C132.818 44.7523 132.857 41.5191 132.23 39.9244C131.661 38.4742 130.026 38.2429 129.738 36.6532C131.718 35.479 133.782 34.0569 135.898 33.1322C142.113 30.4177 151.282 27.8154 157.945 25.9665C161.684 24.9266 167.339 23.1983 170.976 22.6311C171.633 22.5293 172.185 22.538 172.765 22.8869C173.435 23.2103 173.633 23.748 173.859 24.4014C176.313 31.6128 177.316 40.63 178.643 48.1101C178.792 48.9561 179.857 49.8133 180.091 51.2308C180.477 53.5789 178.457 58.522 177.376 60.7182L177.38 60.7103Z',
] as const

/** Placeholder path for extra final paths (point) - closed path to avoid selector parsing */
const PLACEHOLDER_PATH = 'M0,0h0.001v0.001z'

interface MicProps {
  className?: string
}

/**
 * Mic chalk icon with MorphSVG hover morph.
 * Uses unified viewBox 0 0 188 176 so the image won't crop during morph.
 */
function Mic({ className }: MicProps) {
  const wrapperRef = useRef<HTMLDivElement>(null)
  const groupRef = useRef<SVGGElement>(null)
  const tweensRef = useRef<gsap.core.Tween[]>([])

  const morphToFinal = useCallback(() => {
    const wrapper = wrapperRef.current
    const group = groupRef.current
    if (!wrapper || !group) return

    tweensRef.current.forEach((t) => t.kill())
    tweensRef.current = []

    tweensRef.current.push(
      gsap.to(group, {
        duration: 0.5,
        ease: 'power2.inOut',
        scale: 1,
        transformOrigin: '0 0',
      })
    )

    const paths = wrapper.querySelectorAll<SVGPathElement>('[data-mic-path]')
    paths.forEach((path, i) => {
      const targetPath = FINAL_PATHS[Math.min(i, FINAL_PATHS.length - 1)]
      tweensRef.current.push(
        gsap.to(path, {
          duration: 0.5,
          ease: 'power2.inOut',
          morphSVG: { shape: targetPath },
          fill: '#321000',
          opacity: 1,
        })
      )
    })
  }, [])

  const morphToOriginal = useCallback(() => {
    const wrapper = wrapperRef.current
    const group = groupRef.current
    if (!wrapper || !group) return

    tweensRef.current.forEach((t) => t.kill())
    tweensRef.current = []

    tweensRef.current.push(
      gsap.to(group, {
        duration: 0.5,
        ease: 'power2.inOut',
        scaleX: INITIAL_SCALE.x,
        scaleY: INITIAL_SCALE.y,
        transformOrigin: '0 0',
      })
    )

    const paths = wrapper.querySelectorAll<SVGPathElement>('[data-mic-path]')
    paths.forEach((path, i) => {
      const dataOriginal = path.getAttribute('data-original')
      const origPath =
        dataOriginal ?? (i < ORIGINAL_PATHS.length ? ORIGINAL_PATHS[i] : PLACEHOLDER_PATH)
      tweensRef.current.push(
        gsap.to(path, {
          duration: 0.5,
          ease: 'power2.inOut',
          morphSVG: { shape: origPath },
          fill: '#FAF3E7',
          opacity: i === 0 ? 1 : 0,
        })
      )
    })
  }, [])

  return (
    <div
      ref={wrapperRef}
      className={cn('relative cursor-pointer', className)}
      onMouseEnter={morphToFinal}
      onMouseLeave={morphToOriginal}
      role="presentation"
    >
      <svg
        width="188"
        height="176"
        viewBox={VIEWBOX}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        className="block h-auto w-full max-w-[109px] object-contain"
        preserveAspectRatio="xMidYMid meet"
        aria-hidden
      >
        <g
          ref={groupRef}
          style={{
            transformOrigin: '0 0',
            transform: `scale(${INITIAL_SCALE.x}, ${INITIAL_SCALE.y})`,
          }}
        >
          <path
            data-mic-path
            data-original={ORIGINAL_PATHS[0]}
            d={ORIGINAL_PATHS[0]}
            fill="#FAF3E7"
          />
          <path
            data-mic-path
            data-original={PLACEHOLDER_PATH}
            d={PLACEHOLDER_PATH}
            fill="#FAF3E7"
            opacity="0"
          />
          <path
            data-mic-path
            data-original={PLACEHOLDER_PATH}
            d={PLACEHOLDER_PATH}
            fill="#FAF3E7"
            opacity="0"
          />
        </g>
      </svg>
    </div>
  )
}

export default Mic
