import { useRef, useCallback } from 'react'
import gsap from 'gsap'
import { MorphSVGPlugin } from 'gsap/MorphSVGPlugin'
import cn from 'classnames'

gsap.registerPlugin(MorphSVGPlugin)

/** Unified viewBox to prevent cropping during morph (from 180×184 to 218×222) */
const VIEWBOX = '0 0 218 222'

/** Scale initial (180×184) to match final (218×222) size */
const INITIAL_SCALE = { x: 218 / 180, y: 222 / 184 }

/** Original paths (180×184 space) - 6 paths */
const ORIGINAL_PATHS = [
  'M52.6528 132.423C40.3288 125.327 30.5291 111.047 30.2047 96.5318C30.0481 89.5425 32.5806 84.0621 34.0945 77.5977C35.184 72.9402 34.9868 69.64 36.9393 64.7685C44.3471 46.3013 73.9863 25.5754 93.6665 34.4977C108.688 41.3067 101.212 54.1241 101.258 65.3245C101.311 77.7628 113.337 78.4333 120.304 86.0236C130.891 97.553 124.444 113.355 115.087 123.134C99.2794 139.652 72.4644 143.835 52.6528 132.423ZM72.3044 36.5317C58.5195 40.589 44.6296 51.8843 38.5255 64.9775C37.7643 66.6143 35.7584 71.6785 35.6951 73.251C35.6387 74.6614 36.4264 75.2409 36.4799 76.8414C36.5876 80.1474 34.4336 86.688 33.9922 90.5992C30.6766 119.914 59.7089 139.971 86.7419 134.59C103.805 131.193 129.707 112.987 121.687 92.7788C117.756 82.8756 102.877 80.818 99.4722 72.6992C94.6176 61.1277 106.469 46.0348 94.1705 37.8892C88.0913 33.8662 79.0184 34.5511 72.3032 36.5274L72.3044 36.5317Z',
  'M45.6855 98.0611C43.9357 96.8119 44.338 93.881 45.3705 92.2536C48.0666 88.0009 57.5646 86.5018 61.7935 88.6942C67.7988 91.8084 66.4643 98.7232 62.6141 102.952C56.5788 109.577 42.6829 112.296 48.459 98.9983C48.2932 98.5305 46.1618 98.395 45.6898 98.06L45.6855 98.0611ZM49.9663 96.7261C52.8724 99.0138 45.9072 106.575 51.6472 106.338C60.8075 105.964 70.1889 92.6063 57.5862 89.895C52.9611 88.898 47.2646 90.8335 46.8126 96.088C47.5468 96.0231 49.471 96.3379 49.9663 96.7261Z',
  'M100.785 103.161C103.877 102.151 108.26 102.7 110.061 105.711C111.985 108.926 109.009 115.578 106.053 117.545C102.317 120.032 99.8963 118.625 96.0433 118.422C93.862 118.305 91.4248 119.601 89.3959 117.75C86.812 115.389 88.3427 111.583 90.7892 109.758C91.5914 109.162 92.6627 108.961 93.3516 108.419C95.7555 106.537 97.7391 104.155 100.781 103.162L100.785 103.161ZM101.461 105.692C98.7083 106.643 90.684 110.935 90.1673 113.983C89.481 118.052 94.9081 115.96 97.0859 115.996C98.5313 116.019 99.7977 116.822 101.247 116.706C109.725 116.044 111.931 102.065 101.46 105.688L101.461 105.692Z',
  'M58.4152 74.923C55.4708 81.2325 41.9802 80.9469 45.395 71.432C45.9689 69.8274 47.0841 66.8876 47.7579 65.3842C48.9793 62.6721 52.1097 60.1324 55.0344 61.9438C56.2036 63.697 54.7993 66.5087 55.3787 68.0317C55.9581 69.5547 60.4839 70.4869 58.4183 74.9176L58.4152 74.923ZM52.7442 63.1594C49.5805 63.9696 48.3676 68.0107 47.4893 70.8821C46.8832 72.8614 45.7777 75.2908 48.1598 76.5025C50.6582 77.7744 55.4544 76.3054 56.3537 73.5472C57.1009 71.2601 55.2962 71.581 54.3146 70.5139C52.3068 68.3322 53.2758 65.7155 52.7399 63.1606L52.7442 63.1594Z',
  'M67.4807 112.128C71.7501 110.307 70.4003 113.886 71.9097 115.754C73.1152 117.25 81.357 117.411 77.0506 122.628C74.3143 125.944 66.855 128.734 62.6416 127.589C53.8608 125.204 62.8065 114.123 67.4807 112.128ZM68.8359 113.452C65.2645 115.021 60.3942 118.5 60.4077 122.87C60.4202 126.417 64.7799 126.607 67.4891 125.937C68.925 125.583 77.2099 121.5 75.6498 119.665C72.042 118.298 68.5672 118.437 68.8316 113.453L68.8359 113.452Z',
  'M78.9207 49.3444L78.2001 48.2483C79.8955 48.0299 81.2527 46.9876 82.85 46.5212C85.5061 45.7378 92.069 46.5885 93.2142 49.3957C95.6727 55.4178 85.1297 61.3658 79.7534 58.0823C76.5865 56.1485 75.9389 51.6382 78.925 49.3433L78.9207 49.3444ZM80.9495 48.9586C79.014 50.0696 78.073 53.5252 79.5438 55.3847C83.2957 60.1255 93.0285 54.2995 91.5829 50.315C90.6778 47.8275 82.8935 47.8453 80.9495 48.9586Z',
] as const

/** Final paths (218×222 space) - 8 paths */
const FINAL_PATHS = [
  'M101.015 190.459C78.5991 186.898 55.8956 171.219 47.2122 149.815C43.0304 139.509 43.7176 129.922 42.3274 119.449C41.324 111.904 39.1653 107.108 39.3301 98.7552C39.9637 67.0879 72.5272 19.45 106.962 21.5553C133.245 23.1605 129.319 46.4638 135.713 63.0955C142.818 81.5643 161.16 75.7392 175.853 83.0754C198.179 94.2164 197.475 121.375 189.022 141.226C174.742 174.761 137.052 196.193 101.015 190.459ZM76.2036 36.6986C57.9055 50.5526 43.5391 75.2308 41.8174 98.1662C41.6049 101.032 41.4693 109.702 42.2629 112.076C42.9754 114.206 44.4793 114.621 45.4632 116.971C47.4915 121.827 47.9685 132.776 49.5185 138.843C61.1246 184.323 115.818 197.682 153.156 174.345C176.723 159.612 205.128 117.842 181.735 92.3373C170.269 79.839 146.884 85.2194 137.212 75.0764C123.425 60.6207 132.602 31.4508 109.631 26.3134C98.2781 23.7788 85.1132 29.9443 76.1995 36.6929L76.2036 36.6986Z',
  'M71.199 143.308C67.8796 142.443 66.8251 137.856 67.4481 134.85C69.073 126.996 82.4128 119.378 89.9676 120.24C100.697 121.465 102.609 132.506 99.247 140.98C93.9741 154.255 74.7545 166.182 75.8709 143.129C75.3591 142.527 72.0989 143.535 71.2047 143.304L71.199 143.308ZM76.8389 138.895C82.4716 140.648 76.3388 155.844 84.7788 152.237C98.2496 146.483 104.717 121.295 84.3618 124.412C76.8904 125.553 69.475 131.664 71.7679 139.735C72.8279 139.222 75.8798 138.598 76.8389 138.895Z',
  'M156.38 119.636C160.427 116.379 167.284 114.711 171.674 118.167C176.364 121.857 175.676 133.439 172.372 138.04C168.197 143.859 163.786 143.139 157.917 145.023C154.592 146.086 151.684 149.396 147.608 147.794C142.415 145.749 142.552 139.22 145.175 135.118C146.037 133.777 147.523 132.87 148.246 131.673C150.773 127.51 152.391 122.842 156.374 119.64L156.38 119.636ZM158.818 123.017C155.244 125.993 145.683 136.927 146.633 141.755C147.906 148.195 154.83 142.005 158.104 140.824C160.275 140.037 162.621 140.513 164.72 139.519C177.009 133.725 172.407 111.684 158.814 123.012L158.818 123.017Z',
  'M77.1433 101.675C76.3092 112.729 55.9977 119.957 55.7237 103.869C55.6747 101.157 55.6798 96.1525 55.8371 93.5342C56.1294 88.8078 59.3706 83.255 64.7623 84.2898C67.4989 86.2339 66.9895 91.2122 68.7152 93.1486C70.4409 95.0849 77.7275 93.904 77.1449 101.665L77.1433 101.675ZM62.0281 87.3969C57.7604 90.3965 58.2313 97.0947 58.5413 101.863C58.754 105.151 58.475 109.391 62.7175 109.842C67.1676 110.316 73.5016 105.41 73.287 100.798C73.1111 96.9729 70.5969 98.474 68.5279 97.4438C64.2967 95.3381 64.266 90.8967 62.0224 87.401L62.0281 87.3969Z',
  'M111.699 151.865C117.047 146.735 117.053 152.824 120.362 154.745C123.008 156.286 135.409 151.85 131.923 162.052C129.71 168.536 120.144 176.917 113.204 177.605C98.7411 179.038 105.844 157.483 111.699 151.865ZM114.471 153.065C110.023 157.425 104.713 165.362 107.202 171.853C109.224 177.121 115.843 174.93 119.511 172.398C121.456 171.056 131.525 160.285 128.158 158.44C121.997 158.454 116.885 160.632 114.465 153.069L114.471 153.065Z',
  'M93.3231 52.0015L91.6276 50.78C94.0366 49.4935 95.475 47.1735 97.5974 45.5737C101.122 42.9019 111.405 40.444 114.701 43.9693C121.775 51.531 109.387 66.3578 99.5024 64.5244C93.6798 63.4449 90.1649 57.1045 93.3288 51.9974L93.3231 52.0015ZM96.1355 50.2768C93.872 53.0271 94.4183 58.7001 97.6656 60.6313C105.947 65.5537 117.194 51.3677 112.784 46.262C110.027 43.0759 98.4103 47.5182 96.1355 50.2768Z',
  'M1.34854 58.6851C3.17977 57.6058 11.4831 62.1283 13.4607 63.3466C15.1728 64.395 23.2271 69.2255 21.3466 71.6036C19.9578 72.9441 18.3612 72.0442 16.8749 71.5422C13.7576 70.4895 1.56843 63.5883 0.51956 60.8194L1.34854 58.6851Z',
  'M8.96092 40.4359C10.0106 38.6084 15.1262 44.9936 15.7221 45.666C19.3307 49.7233 22.2655 54.3763 26.2111 58.1585L25.9191 60.298C23.4039 61.8717 18.2825 56.2444 16.8176 54.504C15.2329 52.6227 7.91969 42.2479 8.96517 40.4282L8.96092 40.4359Z',
] as const

/** Placeholder path for extra final paths (point) - closed path to avoid selector parsing */
const PLACEHOLDER_PATH = 'M0,0h0.001v0.001z'

interface PaintProps {
  className?: string
}

/**
 * Paint chalk icon with MorphSVG hover morph.
 * Uses unified viewBox 0 0 218 222 so the image won't crop during morph.
 */
function Paint({ className }: PaintProps) {
  const wrapperRef = useRef<HTMLDivElement>(null)
  const groupRef = useRef<SVGGElement>(null)
  const tweensRef = useRef<gsap.core.Tween[]>([])

  const morphToFinal = useCallback(() => {
    const wrapper = wrapperRef.current
    const group = groupRef.current
    if (!wrapper || !group) return

    tweensRef.current.forEach((t) => t.kill())
    tweensRef.current = []

    tweensRef.current.push(
      gsap.to(group, {
        duration: 0.5,
        ease: 'power2.inOut',
        scale: 1,
        transformOrigin: '0 0',
      })
    )

    const paths = wrapper.querySelectorAll<SVGPathElement>('[data-paint-path]')
    paths.forEach((path, i) => {
      const targetPath = FINAL_PATHS[Math.min(i, FINAL_PATHS.length - 1)]
      tweensRef.current.push(
        gsap.to(path, {
          duration: 0.5,
          ease: 'power2.inOut',
          morphSVG: { shape: targetPath },
          fill: '#321000',
          opacity: 1,
        })
      )
    })
  }, [])

  const morphToOriginal = useCallback(() => {
    const wrapper = wrapperRef.current
    const group = groupRef.current
    if (!wrapper || !group) return

    tweensRef.current.forEach((t) => t.kill())
    tweensRef.current = []

    tweensRef.current.push(
      gsap.to(group, {
        duration: 0.5,
        ease: 'power2.inOut',
        scaleX: INITIAL_SCALE.x,
        scaleY: INITIAL_SCALE.y,
        transformOrigin: '0 0',
      })
    )

    const paths = wrapper.querySelectorAll<SVGPathElement>('[data-paint-path]')
    paths.forEach((path, i) => {
      const dataOriginal = path.getAttribute('data-original')
      const origPath =
        dataOriginal ?? (i < ORIGINAL_PATHS.length ? ORIGINAL_PATHS[i] : PLACEHOLDER_PATH)
      tweensRef.current.push(
        gsap.to(path, {
          duration: 0.5,
          ease: 'power2.inOut',
          morphSVG: { shape: origPath },
          fill: '#FAF3E7',
          opacity: i < ORIGINAL_PATHS.length ? 1 : 0,
        })
      )
    })
  }, [])

  return (
    <div
      ref={wrapperRef}
      className={cn('relative cursor-pointer', className)}
      onMouseEnter={morphToFinal}
      onMouseLeave={morphToOriginal}
      role="presentation"
    >
      <svg
        width="218"
        height="222"
        viewBox={VIEWBOX}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        className="block h-auto w-full max-w-[116px] object-contain"
        preserveAspectRatio="xMidYMid meet"
        aria-hidden
      >
        <g
          ref={groupRef}
          style={{
            transformOrigin: '0 0',
            transform: `scale(${INITIAL_SCALE.x}, ${INITIAL_SCALE.y})`,
          }}
        >
          {ORIGINAL_PATHS.map((d, i) => (
            <path
              key={i}
              data-paint-path
              data-original={d}
              d={d}
              fill="#FAF3E7"
            />
          ))}
          <path
            data-paint-path
            data-original={PLACEHOLDER_PATH}
            d={PLACEHOLDER_PATH}
            fill="#FAF3E7"
            opacity="0"
          />
          <path
            data-paint-path
            data-original={PLACEHOLDER_PATH}
            d={PLACEHOLDER_PATH}
            fill="#FAF3E7"
            opacity="0"
          />
        </g>
      </svg>
    </div>
  )
}

export default Paint
